name: CI Pipeline

on:
  push:
    branches:
      - develop
      - "feature/**"
      - "fix/**"
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/CODEOWNERS"
  pull_request:
    branches: [develop]
    paths-ignore:
      - "**.md"
      - "docs/**"

env:
  NODE_VERSION: "22"

jobs:
  # ============================================
  # Detect which services have changed
  # ============================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      user-service: ${{ steps.filter.outputs.user-service }}
      message-service: ${{ steps.filter.outputs.message-service }}
      workspace-channel-service: ${{ steps.filter.outputs.workspace-channel-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      bff-service: ${{ steps.filter.outputs.bff-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            user-service:
              - 'services/user-service/**'
            message-service:
              - 'services/message-service/**'
            workspace-channel-service:
              - 'services/workspace-channel-service/**'
            notification-service:
              - 'services/notification-service/**'
            bff-service:
              - 'services/bff-service/**'
            frontend:
              - 'frontend/**'
            shared:
              - 'services/shared/**'
              - 'package.json'
              - 'package-lock.json'

  # ============================================
  # User Service CI
  # ============================================
  user-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.user-service == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          cd services/shared/logger && npm ci
          cd ../telemetry && npm ci
          cd ../metrics && npm ci
          cd ../http-client && npm ci
          cd ../../user-service && npm ci

      - name: Lint
        run: npm run lint --workspace=services/user-service

      - name: Type Check
        run: npm run build:tsc --workspace=services/user-service

      - name: Unit Tests
        run: npm run test:unit --workspace=services/user-service

      - name: Build Check
        run: npm run build --workspace=services/user-service

  # ============================================
  # Message Service CI
  # ============================================
  message-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.message-service == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          cd services/shared/logger && npm ci
          cd ../telemetry && npm ci
          cd ../metrics && npm ci
          cd ../http-client && npm ci
          cd ../../message-service && npm ci

      - name: Lint
        run: npm run lint --workspace=services/message-service

      - name: Type Check
        run: npm run build:tsc --workspace=services/message-service

      - name: Unit Tests
        run: npm run test:unit --workspace=services/message-service

      - name: Build Check
        run: npm run build --workspace=services/message-service

  # ============================================
  # Workspace-Channel Service CI
  # ============================================
  workspace-channel-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.workspace-channel-service == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          cd services/shared/logger && npm ci
          cd ../telemetry && npm ci
          cd ../metrics && npm ci
          cd ../http-client && npm ci
          cd ../../workspace-channel-service && npm ci

      - name: Lint
        run: npm run lint --workspace=services/workspace-channel-service

      - name: Type Check
        run: npm run build:tsc --workspace=services/workspace-channel-service

      - name: Unit Tests
        run: npm run test:unit --workspace=services/workspace-channel-service

      - name: Build Check
        run: npm run build --workspace=services/workspace-channel-service

  # ============================================
  # Notification Service CI
  # ============================================
  notification-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.notification-service == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          cd services/shared/logger && npm ci
          cd ../telemetry && npm ci
          cd ../metrics && npm ci
          cd ../http-client && npm ci
          cd ../../notification-service && npm ci

      - name: Lint
        run: npm run lint --workspace=services/notification-service

      - name: Unit Tests
        run: npm run test:unit --workspace=services/notification-service

      - name: Build Check
        run: npm run build --workspace=services/notification-service

  # ============================================
  # BFF Service CI
  # ============================================
  bff-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.bff-service == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          cd services/shared/logger && npm ci
          cd ../telemetry && npm ci
          cd ../metrics && npm ci
          cd ../http-client && npm ci
          cd ../../bff-service && npm ci

      - name: Lint
        run: npm run lint --workspace=services/bff-service

      - name: Type Check
        run: npm run build:tsc --workspace=services/bff-service

      # Note: BFF service currently has no tests - add tests then uncomment
      # - name: Unit Tests
      #   run: npm run test:unit --workspace=services/bff-service

      - name: Build Check
        run: npm run build --workspace=services/bff-service

  # ============================================
  # Frontend CI
  # ============================================
  frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3000
          NEXT_PUBLIC_BFF_URL: http://localhost:8004

  # ============================================
  # Summary Job
  # ============================================
  ci-success:
    needs:
      [
        detect-changes,
        user-service,
        message-service,
        workspace-channel-service,
        notification-service,
        bff-service,
        frontend,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check CI Results
        run: |
          if [[ "${{ needs.user-service.result }}" == "failure" ]] || \
             [[ "${{ needs.message-service.result }}" == "failure" ]] || \
             [[ "${{ needs.workspace-channel-service.result }}" == "failure" ]] || \
             [[ "${{ needs.notification-service.result }}" == "failure" ]] || \
             [[ "${{ needs.bff-service.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend.result }}" == "failure" ]]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi
          echo "✅ All CI jobs passed (or were skipped due to no changes)"
