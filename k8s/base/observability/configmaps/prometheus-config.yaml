# prometheus-config.yaml
# Prometheus configuration for scraping Echo services and infrastructure
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: echo-observability
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      scrape_timeout: 10s
      external_labels:
        monitor: "echo-monitor"
        environment: "staging"

    scrape_configs:
      # Prometheus self-monitoring
      - job_name: "prometheus"
        static_configs:
          - targets: ["localhost:9090"]
            labels:
              service: "prometheus"

      # OpenTelemetry Collector metrics
      - job_name: "otel-collector"
        static_configs:
          - targets: ["otel-collector.echo-observability:8888"]
            labels:
              service: "otel-collector"

      # Echo Application Services (in echo namespace)
      - job_name: "user-service"
        static_configs:
          - targets: ["user-service.echo:8001"]
            labels:
              service: "user-service"
        metrics_path: /metrics

      - job_name: "workspace-channel-service"
        static_configs:
          - targets: ["workspace-channel-service.echo:8002"]
            labels:
              service: "workspace-channel-service"
        metrics_path: /metrics

      - job_name: "message-service"
        static_configs:
          - targets: ["message-service.echo:8003"]
            labels:
              service: "message-service"
        metrics_path: /metrics

      - job_name: "bff-service"
        static_configs:
          - targets: ["bff-service.echo:8004"]
            labels:
              service: "bff-service"
        metrics_path: /metrics

      - job_name: "notification-service"
        static_configs:
          - targets: ["notification-service.echo:8005"]
            labels:
              service: "notification-service"
        metrics_path: /metrics

      # RabbitMQ (external, via host.minikube.internal)
      - job_name: "rabbitmq"
        static_configs:
          - targets: ["host.minikube.internal:15692"]
            labels:
              service: "rabbitmq"
        metrics_path: /metrics
        scrape_interval: 30s
