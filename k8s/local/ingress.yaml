# ingress.yaml
# NGINX Ingress for local Minikube deployment
#
# Prerequisites:
#   minikube addons enable ingress
#
# DNS Configuration:
#   Add to /etc/hosts (or C:\Windows\System32\drivers\etc\hosts):
#   <minikube-ip> echo.local api.echo.local
#
# Or use minikube tunnel and:
#   127.0.0.1 echo.local api.echo.local
#
# WebSocket Support:
#   This ingress is configured for Socket.IO WebSocket connections.
#   The BFF service uses Socket.IO for real-time communication.
#
# Verify with:
#   curl "http://api.echo.local/socket.io/?EIO=4&transport=polling"
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: echo-ingress
  namespace: echo
  annotations:
    # Request size and timeouts
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"

    # WebSocket support for BFF service (Socket.IO)
    nginx.ingress.kubernetes.io/websocket-services: "bff-service"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"

    # HTTP/1.1 for WebSocket upgrade support
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"

    # Connection upgrade headers for WebSocket
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
spec:
  ingressClassName: nginx
  rules:
    # Frontend - Main application UI
    - host: echo.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 3000
    # BFF API and WebSocket endpoint
    - host: api.echo.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: bff-service
                port:
                  number: 8004
